---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cluster-apps-flagger
  namespace: ci-cd-system
spec:
  interval: 1h
  releaseName: flagger
  install: # override existing Flagger CRDs
    crds: CreateReplace
  upgrade: # update Flagger CRDs
    crds: CreateReplace
  chart:
    spec:
      chart: flagger
      version: 1.x # update Flagger to the latest minor version
      interval: 6h # scan for new versions every six hours
      sourceRef:
        kind: HelmRepository
        name: flagger
        namespace: flux-system
      verify: # verify the chart signature with Cosign keyless
        provider: cosign
  values:
    image:
      repository: ghcr.io/fluxcd/flagger
      tag: 1.34.0
      pullPolicy: IfNotPresent

    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8080"
      appmesh.k8s.aws/sidecarInjectorWebhook: disabled
      linkerd.io/inject: enabled

    metricsServer: "https://prometheus.${SECRET_DOMAIN}"
    clusterName: home-kubernetes
    # accepted values are kubernetes, istio, linkerd, appmesh, contour, nginx, gloo, skipper, traefik, apisix, osm
    meshProvider: ""

    ingressClass: internal

    nodeSelector:
      kubernetes.io/os: linux

    resources:
      limits:
        memory: "512Mi"
        cpu: "1000m"
      requests:
        memory: "32Mi"
        cpu: "10m"
